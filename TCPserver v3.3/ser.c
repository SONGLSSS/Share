#include<stdio.h>#include<stdlib.h>#include<string.h>#include<sys/types.h>#include<sys/socket.h>#include<netinet/in.h>#include<unistd.h>#include<fcntl.h>#include<errno.h>#include<time.h>//#include<windows.h>//#include<winsock.h>//#include <sys/socket.h>//#include <netinet/in.h>//#include <arpa/inet.h>//#include<winsock2.h>//#pragma comment(lib,"Ws2_32.lib")//#include<winsock.h>extern int errno;char* getNowtime(void);int main(){//	pid实际上是int,相当于句柄 	pid_t client = 0;	char send[128] = {0};	char recv[128] = {0};	char buffer[128] = {0};	char*time_string;//	char *test;//	socket句柄 	int pipe_fd[2]={0};	int server_fd,client_fd,ret;//	用来处理网络通信地址的结构体 	struct sockaddr_in server_address,client_address;//	配置服务器结构体：通信协议、IP地址、端口号 "172.17.0.49"	bzero(&server_address,sizeof(struct sockaddr_in));	bzero(&client_address,sizeof(struct sockaddr_in));		server_address.sin_family = AF_INET;	server_address.sin_addr.s_addr = inet_addr("127.0.0.1");	server_address.sin_port = htons(8888);	/*//test	printf("here is test:\n");	test = inet_ntoa(server_address);	printf("test:%s\n",test);	*/	int addr_length=sizeof(server_address);       //	创建socket 	server_fd = socket(AF_INET,SOCK_STREAM,0);	if(-1 == server_fd){		printf("socket failed!\n");		fprintf(stderr, "Value of error: %d\n", errno);		fprintf(stderr, "ERROR: %s\n", strerror(errno));		return -1;	}else{		printf("socket success.\n");		}//	bind()函数把地址族中特定地址赋给socket 	ret = bind(server_fd,(struct sockaddr *)(&server_address), sizeof(struct sockaddr));	if(-1 == ret){		printf("bind failed!\n");		printf("return:%d\n",ret);		fprintf(stderr, "Value of error: %d\n", errno);		fprintf(stderr, "ERROR: %s\n", strerror(errno));		return -1;	}else{		printf("bind success.\n");		}//	listen把socket变为被动模式，等待用户连接 	ret = listen(server_fd,20);	if(-1 == ret){		printf("listen failed!");		printf("return:%d\n",ret);		fprintf(stderr, "Value of error: %d\n", errno);		fprintf(stderr, "ERROR: %s\n", strerror(errno));		return -1;	}else{		printf("Listen success.\n");		}		int cnt=0;	do{		client_fd = accept(server_fd,(struct sockaddr *)(&client_address),&addr_length);				if(-1 == client_fd){		   	printf("Connected failed !\r\n");		    printf("return:%d\n",ret);			fprintf(stderr, "Value of error: %d\n", errno);			fprintf(stderr, "ERROR: %s\n", strerror(errno));		    return -1;		}else{			printf("Connected successfully.\n");		}		pipe(pipe_fd);		client = fork();		if(client < 0){			printf("Fork failed !\r\n");			printf("PID:%d\n",getpid());			fprintf(stderr, "Value of error: %d\n", errno);			fprintf(stderr, "ERROR: %s\n", strerror(errno));		}else if(0 == client){//			子进程						close(server_fd);			close(pipe_fd[1]);        	read(pipe_fd[0], buffer, sizeof(buffer));			//printf("%s",buffer);			ret = write(client_fd, buffer, strlen(buffer));			if(-1 == ret){				printf("Write fail!\r\n");				printf("return:%d\n",ret);				fprintf(stderr, "Value of error: %d\n", errno);				fprintf(stderr, "ERROR: %s\n", strerror(errno));			    return -1;			}			do{		    						memset(send,0,sizeof(send));				printf("Enter what your want send:\n");				//scanf("%s",send);				gets(send);								strcat(send,buffer);				ret = write(client_fd, send, strlen(send));								if(-1 == ret){				   	printf("Write fail!\r\n");				    printf("return:%d\n",ret);					fprintf(stderr, "Value of error: %d\n", errno);					fprintf(stderr, "ERROR: %s\n", strerror(errno));				    return -1;				}else{					printf("Server are waiting for messages...\n");						}				ret = read(client_fd, recv,sizeof(recv));								if(-1 == ret){			    		printf("read fail!\r\n");			    		printf("return:%d\n",ret);					fprintf(stderr, "Value of error: %d\n", errno);					fprintf(stderr, "ERROR: %s\n", strerror(errno));					return -1;				}else{					printf("[Client %d]: %s\n",getpid(), recv);				}								memset(recv,0,sizeof(recv));				memset(buffer,0,sizeof(buffer));			}while(1);						close(client_fd);			printf("Communication terminated.\n");		}else{//			父进程			cnt++;			close(client_fd);			close(pipe_fd[0]);			char log[32]={0};						sprintf(log,"\nYou are the No.%d client today",cnt);			time_string =  getNowtime();			strcat(log,time_string);						//printf("log+time:%s\n",log);			write(pipe_fd[1], log, strlen(log));			memset(log,0,sizeof(log));			memset(time_string,0,sizeof(time_string));			free(time_string);		}	}while(1);	printf("Connection terminated.\n");	close(server_fd);		return 0;}char* getNowtime(void){	    	char YMD[15] = {0};    	char HMS[10] = {0};	char *string = (char*)malloc(21*sizeof(char));		    	time_t current_time;    	struct tm* now_time;    	time(&current_time);    	now_time = localtime(&current_time);    	strftime(YMD, sizeof(YMD), "%F ", now_time);    	strftime(HMS, sizeof(HMS), "%T", now_time);    	    	strncat(string, YMD, 11);    	strncat(string, HMS, 8);	    return string;}